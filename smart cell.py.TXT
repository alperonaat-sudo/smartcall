import os
import sys
import threading
import time
import json
from typing import Optional
import pyautogui
import pyperclip
from pynput import keyboard as pyn_keyboard
import customtkinter as ctk
from tkinter import Toplevel, filedialog, messagebox
import openpyxl

# ---------------- Masa√ºst√º klas√∂r√º ve ayarlar dosyasƒ± ----------------
DESKTOP = os.path.join(os.path.expanduser("~"), "Desktop")
SMARTCALL_DIR = os.path.join(DESKTOP, "SmartCall")
AYARLAR_DOSYA = os.path.join(SMARTCALL_DIR, "ayarlar.json")

# Klas√∂r yoksa olu≈ütur
if not os.path.exists(SMARTCALL_DIR):
    os.makedirs(SMARTCALL_DIR)


# ================== Dosya Yolu ==================
BASE_DIR = getattr(sys, "_MEIPASS", os.path.dirname(os.path.abspath(__file__)))
DESKTOP = os.path.join(os.path.expanduser("~"), "Desktop")
INVEKTO_DIR = os.path.join(DESKTOP, "Invekto")
os.makedirs(INVEKTO_DIR, exist_ok=True)
AYARLAR_DOSYA = os.path.join(INVEKTO_DIR, "ayarlar.json")

# ================== Ayar Dosyasƒ± (dosya i≈ülemleri) ==================
def save_settings(data):
    """Not ayarlarƒ±nƒ± Invekto klas√∂r√ºne kaydet"""
    try:
        with open(AYARLAR_DOSYA, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    except Exception as e:
        print("save_settings hata:", e)


def load_settings_file():
    """Invekto klas√∂r√ºnden ayarlarƒ± y√ºkle"""
    if os.path.exists(AYARLAR_DOSYA):
        try:
            with open(AYARLAR_DOSYA, "r", encoding="utf-8") as f:
                return json.load(f)
        except Exception as e:
            print("load_settings_file hata:", e)
            return None
    return {"durum_tanimlari": {}, "not_al": False, "show_not_window": True}

# -------------------- Excel Ayƒ±rma √ñzelliƒüi --------------------


class ExcelAyirici:
    def __init__(self, parent):
        self.parent = parent
        self.excel_path = None
        self.durumlar = []
        self.secili_durumlar = []
        self.manual_durum = ""

        self.window = ctk.CTkToplevel(parent)
        self.window.title("Excel Ayƒ±rma")
        self.window.geometry("480x500")

        ctk.CTkButton(self.window, text="üìÇ Excel Se√ß", command=self.choose_excel).pack(pady=10, fill="x", padx=20)
        self.frame_durumlar = ctk.CTkScrollableFrame(self.window, width=440, height=300)
        self.frame_durumlar.pack(padx=20, pady=10, fill="both", expand=True)

        ctk.CTkButton(self.window, text="‚úÖ Kaydet", command=self.save_filtered_excel, fg_color="green").pack(pady=10, fill="x", padx=20)
        ctk.CTkButton(self.window, text="‚ùå Kapat", command=self.window.destroy, fg_color="red").pack(pady=5, fill="x", padx=20)

    def choose_excel(self):
        path = filedialog.askopenfilename(filetypes=[("Excel files", "*.xlsx")])
        if not path:
            return
        self.excel_path = path
        self.load_durumlar()

    def load_durumlar(self):
        for widget in self.frame_durumlar.winfo_children():
            widget.destroy()
        self.durumlar.clear()

        wb = openpyxl.load_workbook(self.excel_path)
        ws = wb.active
        for row_idx in range(2, ws.max_row + 1):
            val = ws.cell(row=row_idx, column=3).value
            if val and val not in self.durumlar:
                self.durumlar.append(val)
        wb.close()

        # Checkbox / Button listesi
        self.check_vars = {}
        for durum in self.durumlar:
            var = ctk.BooleanVar(value=False)
            chk = ctk.CTkCheckBox(self.frame_durumlar, text=durum, variable=var)
            chk.pack(anchor="w", pady=2, padx=5)
            self.check_vars[durum] = var

        # Manuel durum giri≈üi
        ctk.CTkLabel(self.frame_durumlar, text="Manuel Durum Ekle:").pack(anchor="w", pady=(10,2), padx=5)
        self.manual_entry = ctk.CTkEntry(self.frame_durumlar)
        self.manual_entry.pack(fill="x", padx=5)

    def save_filtered_excel(self):
        # se√ßili durumlarƒ± al
        self.secili_durumlar = [d for d, var in self.check_vars.items() if var.get()]
        manual_val = self.manual_entry.get().strip()
        if manual_val:
            self.secili_durumlar.append(manual_val)

        if not self.secili_durumlar:
            messagebox.showwarning("Uyarƒ±", "En az bir durum se√ßin veya manuel girin!")
            return

        save_path = filedialog.asksaveasfilename(defaultextension=".xlsx", filetypes=[("Excel files", "*.xlsx")])
        if not save_path:
            return

        # Excel filtreleme ve kaydetme
        wb = openpyxl.load_workbook(self.excel_path)
        ws = wb.active
        new_wb = openpyxl.Workbook()
        new_ws = new_wb.active

        # Ba≈ülƒ±klarƒ± kopyala
        for col in range(1, ws.max_column + 1):
            new_ws.cell(row=1, column=col, value=ws.cell(row=1, column=col).value)

        new_row = 2
        for row_idx in range(2, ws.max_row + 1):
            val = ws.cell(row=row_idx, column=3).value
            if val in self.secili_durumlar:
                for col in range(1, ws.max_column + 1):
                    new_ws.cell(row=new_row, column=col, value=ws.cell(row=row_idx, column=col).value)
                new_row += 1

        new_wb.save(save_path)
        new_wb.close()
        messagebox.showinfo("Tamamlandƒ±", f"{len(self.secili_durumlar)} durum se√ßildi ve yeni Excel kaydedildi!")

# ================== Ana Bot ==================
class InvektoBot(ctk.CTk):
    def __init__(self):
        super().__init__()
        self.title("üìû Invekto Smart Call")
        self.geometry("360x600")

        # Excel / arama deƒüi≈ükenleri
        self.excel_path: Optional[str] = None
        self.ara_coord = None
        self.kapat_coord = None
        self.numbers: list[tuple[int, str]] = []
        self.start_index = 0
        self.running = False
        self.worker_thread: Optional[threading.Thread] = None

        # Not ayarlarƒ± ve UI deƒüi≈ükenleri
        self.not_al = ctk.BooleanVar(value=False)
        self.otomatik_mod = ctk.BooleanVar(value=False)
        self.show_not_window = ctk.BooleanVar(value=True)

        # Hotkey: default F8
        self.hotkey = pyn_keyboard.Key.f8
        self.hotkey_str = "f8"

        # durum tanƒ±mlarƒ± (1..9)
        self.durum_tanimlari = {i: f"Durum {i}" for i in range(1, 10)}

        # numaralara ait ge√ßici notlar
        self.numara_durumlari: dict[str, str] = {}

        # UI / pencere referanslarƒ±
        self.durum_entries = {}
        self.not_win = None
        self.current_num = None
        self.unused_win = None  # yeni pencere referansƒ±

        self._stop_event = threading.Event()

        self.stop_unused = False

        # UI olu≈ütur
        self._build_ui()

        # Ayarlarƒ± y√ºkle
        try:
            self.load_settings()
        except Exception as e:
            print("load_settings hata:", e)

        # klavye dinleyici
        self.listener = pyn_keyboard.Listener(on_press=self.on_key_press)
        self.listener.start()

        self.protocol("WM_DELETE_WINDOW", self.on_closing)


    # -------------------- UI --------------------
    def _build_ui(self):
        self.label_sayac = ctk.CTkLabel(self, text="Aranan: 0/0  |  Kalan: 0", font=("Arial", 14))
        self.label_sayac.pack(pady=10)

        frame_top = ctk.CTkFrame(self)
        frame_top.pack(pady=5, fill="x", padx=10)
        ctk.CTkButton(frame_top, text="üìÇ Excel Se√ß", command=self.load_excel).pack(pady=5, fill="x")
        ctk.CTkButton(frame_top, text="üéØ Arama Kutusu Kordinat Se√ß", command=self.set_coord).pack(pady=5, fill="x")
        ctk.CTkButton(frame_top, text="‚ùå √áaƒürƒ±yƒ± Bitir Kordinat Se√ß", command=self.set_kapat_coord,
                      fg_color="#B71C1C", text_color="white", hover_color="#7F0000").pack(pady=5, fill="x")

        self.btn_start = ctk.CTkButton(frame_top, text="‚ñ∂ Ba≈ülat", command=self.toggle_bot, fg_color="green")
        self.btn_start.pack(pady=5, fill="x")

        frame_mod = ctk.CTkFrame(self)
        frame_mod.pack(pady=5, fill="x", padx=10)
        #ctk.CTkSwitch(frame_mod, text="", variable=self.otomatik_mod,  # BU KISIM SES ƒ∞≈ûLEME ƒ∞LE Bƒ∞RLƒ∞KTE DEVREYE ALINACAKTIR
                      #text_color="white").pack(side="left", padx=5)
        ctk.CTkLabel(frame_mod, text="(ESC ile durdur)", text_color="red").pack(side="left", padx=10)

        frame_hotkey = ctk.CTkFrame(self)
        frame_hotkey.pack(pady=5, fill="x", padx=10)
        ctk.CTkLabel(frame_hotkey, text="Ba≈ülat/Durdur Tu≈üu:").pack(side="left", padx=5)
        self.entry_hotkey = ctk.CTkEntry(frame_hotkey, placeholder_text="√∂rn: F8 veya z", width=120)
        self.entry_hotkey.pack(side="left", padx=5)
        ctk.CTkButton(frame_hotkey, text="Ata", command=self.set_hotkey).pack(side="left", padx=5)

        frame_durum_btn = ctk.CTkFrame(self)
        frame_durum_btn.pack(pady=5, fill="x", padx=10)
        ctk.CTkButton(frame_durum_btn, text="üìù Not Ayarlarƒ±", command=self.open_not_ayar).pack(pady=5, fill="x")

        frame_bottom = ctk.CTkFrame(self)
        frame_bottom.pack(pady=5, fill="x", padx=10)
        ctk.CTkButton(frame_bottom, text="üíæ Excel‚Äôi Kaydet", command=self.save_excel, fg_color="blue").pack(
            side="left", expand=True, fill="x", padx=5, pady=5)
        ctk.CTkButton(frame_bottom, text="üíæ Kaydet & √áƒ±k", command=self.on_closing, fg_color="red").pack(
            side="left", expand=True, fill="x", padx=5, pady=5)

        frame_extra = ctk.CTkFrame(self)
        frame_extra.pack(side="bottom", fill="x", padx=10, pady=10)
        ctk.CTkButton(frame_extra, text="üìä Excel Ayƒ±r", command=lambda: ExcelAyirici(self),
                      fg_color="#1976D2", text_color="white", hover_color="#1565C0").pack(pady=5, fill="x")

        ctk.CTkLabel(frame_extra, text="model:0.0.1", font=("Arial", 10), text_color="gray").pack(pady=2)

        # ---- Excel Kaydet Fonksiyonu ----

    def save_excel(self):
        if not self.excel_path:
            messagebox.showwarning("Uyarƒ±", "Kaydedilecek bir Excel dosyasƒ± yok!")
            return
        try:
            wb = openpyxl.load_workbook(self.excel_path)
            ws = wb.active
            durum_col = 3
            for idx, num in self.numbers:
                durum = self.numara_durumlari.get(num, "")
                if durum:  # sadece durum varsa g√ºncelle
                    ws.cell(row=idx, column=durum_col, value=durum)
            wb.save(self.excel_path)
            wb.close()

            messagebox.showinfo(
                "Kaydedildi",
                f"Notlar '{os.path.basename(self.excel_path)}' dosyasƒ±na kaydedildi."
            )
        except Exception as e:
            messagebox.showerror("Kaydetme Hatasƒ±", f"Excel kaydedilemedi:\n{e}")

    # -------------------- G√ºvenli Kapanƒ±≈ü --------------------
    def safe_exit(self):
        try:
            self.on_closing()
        except Exception as e:
            print("Kapanƒ±≈ü sƒ±rasƒ±nda hata:", e)
        finally:
            try:
                os._exit(0)
            except Exception:
                pass

    # -------------------- Ayar Kaydet / Y√ºkle ( NOT AYARLARI) -------------------
    def save_settings(self):
        """
        Sadece 'Not Ayarlarƒ±' kalƒ±cƒ± olacak:
        - durum_tanimlari (anahtarlar string olarak yazƒ±lƒ±r)
        - not_al (bool)
        - show_not_window (bool)
        - hotkey_str (string)
        NOT: numara_durumlari veya excel verileri JSON'a yazƒ±lmaz.
        """
        try:
            data = {
                "durum_tanimlari": {str(k): v for k, v in self.durum_tanimlari.items()},
                "not_al": bool(self.not_al.get()),
                "show_not_window": bool(self.show_not_window.get()),
                "hotkey_str": getattr(self, "hotkey_str", "") or "",
            }
            # global fonksiyonu √ßaƒüƒ±r
            save_settings(data)
        except Exception as e:
            print("Ayarlar kaydedilemedi:", e)

    def load_settings(self):
        """
        Y√ºkleme: JSON'dan durum_tanimlari alƒ±nƒ±r (string anahtarlar -> int anahtarlar).
        Ayrƒ±ca not_al, show_not_window ve hotkey_str geri y√ºklenir.
        """
        data = load_settings_file()
        if not data:
            return

        # durum_tanimlari: anahtarlarƒ± int'e √ßevir
        raw = data.get("durum_tanimlari", {})
        converted = {}
        for k, v in raw.items():
            try:
                ik = int(k)
            except Exception:
                continue
            converted[ik] = v
        if converted:
            self.durum_tanimlari.update(converted)

        # boolean ayarlar
        try:
            self.not_al.set(bool(data.get("not_al", False)))
            self.show_not_window.set(bool(data.get("show_not_window", True)))
        except Exception:
            pass

        # hotkey_str
        hk = data.get("hotkey_str", "")
        if hk:
            try:
                if isinstance(hk, str) and hk.startswith("f") and hk[1:].isdigit():
                    self.hotkey = getattr(pyn_keyboard.Key, hk)
                else:
                    self.hotkey = hk
                self.hotkey_str = hk
                # entry varsa doldur
                try:
                    if hasattr(self, "entry_hotkey") and isinstance(self.entry_hotkey, ctk.CTkEntry):
                        self.entry_hotkey.delete(0, "end")
                        self.entry_hotkey.insert(0, hk)
                except Exception:
                    pass
            except Exception:
                self.hotkey_str = hk

    # -------------------- UI / Excel --------------------
    def ui_call(self, fn, *args, **kwargs):
        self.after(0, lambda: fn(*args, **kwargs))

    def load_excel(self):
        path = filedialog.askopenfilename(filetypes=[("Excel files", "*.xlsx")])
        if not path:
            return
        try:
            wb = openpyxl.load_workbook(path)
            sheet = wb.active
            self.numbers.clear()
            for row_idx in range(2, sheet.max_row + 1):
                num = sheet.cell(row=row_idx, column=1).value
                if num:
                    self.numbers.append((row_idx, str(num)))
            wb.close()
            self.excel_path = path

            def set_start():
                try:
                    start_val = int(entry_start.get())
                    if start_val < 1 or start_val > len(self.numbers):
                        raise ValueError
                    self.start_index = start_val - 1
                    top.destroy()
                    messagebox.showinfo(
                        "Excel Y√ºklendi", f"{len(self.numbers)} numara bulundu.\nBa≈ülangƒ±√ß satƒ±rƒ±: {start_val}"
                    )
                    self.update_sayac()
                except Exception:
                    messagebox.showerror("Hata", "Ge√ßerli bir sayƒ± giriniz!")

            top = Toplevel(self)
            top.title("Ba≈ülangƒ±√ß Satƒ±rƒ±")
            top.geometry("400x180")

            lbl = ctk.CTkLabel(top, text="Ka√ßƒ±ncƒ± sƒ±radan ba≈ülansƒ±n?", text_color="black")
            lbl.pack(pady=15)

            entry_start = ctk.CTkEntry(top, width=120)
            entry_start.insert(0, "1")
            entry_start.pack(pady=10)

            btn_ok = ctk.CTkButton(top, text="Tamam", command=set_start)
            btn_ok.pack(pady=10)

        except Exception as e:
            messagebox.showerror("Hata", f"Excel okunamadƒ±:\n{e}")

    def set_coord(self):
        messagebox.showinfo("Koordinat", "Arama kutusuna fareyi g√∂t√ºr ve 3 sn bekle...")
        self.after(3000, self._capture_ara_coord)

    def _capture_ara_coord(self):
        self.ara_coord = pyautogui.position()
        messagebox.showinfo("Koordinat", f"Arama Kutusu: {self.ara_coord}")

    def set_kapat_coord(self):
        messagebox.showinfo("Koordinat", "Kapat butonuna fareyi g√∂t√ºr ve 3 sn bekle...")
        self.after(3000, self._capture_kapat_coord)

    def _capture_kapat_coord(self):
        self.kapat_coord = pyautogui.position()
        messagebox.showinfo("Koordinat", f"Arama Kapat: {self.kapat_coord}")

    def set_hotkey(self):
        key = self.entry_hotkey.get().strip().lower()
        if not key:
            messagebox.showerror("Hata", "L√ºtfen bir tu≈ü girin! (√∂rn: F8 veya z)")
            return
        try:
            if key.startswith("f") and key[1:].isdigit():
                # e.g. f8 -> Key.f8
                self.hotkey = getattr(pyn_keyboard.Key, key)
            else:
                # single character hotkey
                self.hotkey = key
            self.hotkey_str = key
            messagebox.showinfo("Kƒ±sayol Ayarlandƒ±", f"Ba≈ülat/Durdur i√ßin yeni tu≈ü: {key.upper()}")
            # deƒüi≈üikliƒüi kaydet (not ayarlarƒ±nƒ± kaydeT,)
            try:
                self.save_settings()
            except Exception:
                pass
        except Exception as e:
            messagebox.showerror("Hata", f"Kƒ±sayol atanamadƒ±: {e}")

    def update_sayac(self):
        self.label_sayac.configure(
            text=f"Aranan: {self.start_index}/{len(self.numbers)}  |  Kalan: {max(0, len(self.numbers) - self.start_index)}"
        )

    # -------------------- Bot √áalƒ±≈ütƒ±r / Durdur --------------------
    def toggle_bot(self):
        if self.running:
            self.running = False
            self._stop_event.set()
            if self.worker_thread and self.worker_thread.is_alive():
                self.worker_thread.join(timeout=1.0)
            self.btn_start.configure(text="‚ñ∂ Ba≈ülat", fg_color="green")
        else:
            if not self.numbers:
                messagebox.showwarning("Uyarƒ±", "√ñnce Excel y√ºkleyin.")
                return
            self.running = True
            self._stop_event.clear()
            self.worker_thread = threading.Thread(target=self.run_bot, daemon=True)
            self.worker_thread.start()
            self.btn_start.configure(text="‚èπ Durdur", fg_color="red")

    def run_bot(self):
        while self.running and not self._stop_event.is_set() and self.start_index < len(self.numbers):
            idx, num = self.numbers[self.start_index]

            try:
                if self.ara_coord:
                    pyautogui.click(self.ara_coord)
                    time.sleep(0.1)
                    pyautogui.click(self.ara_coord)
                    pyperclip.copy(str(num))  # str() ekledik
                    pyautogui.hotkey("ctrl", "v")
                    time.sleep(0.05)
                    pyautogui.press("enter")

                if self.otomatik_mod.get() and self.kapat_coord:
                    time.sleep(__import__("random").randint(4, 7))
                    pyautogui.click(self.kapat_coord)
                    time.sleep(0.7)

                self.start_index += 1
                self.ui_call(self.update_sayac)

                if self.not_al.get() and self.show_not_window.get():
                    self.current_num = num
                    self.ui_call(self.show_not_al_window, num)

                if not self.otomatik_mod.get():
                    break

            except Exception as e:
                print("run_bot hata:", e)
                self.start_index += 1

        self.running = False
        self.ui_call(self.btn_start.configure, text="‚ñ∂ Ba≈ülat", fg_color="green")

    # -------------------- Not Ayarlarƒ± --------------------
    def open_not_ayar(self):
        win = Toplevel(self)
        win.title("Not Ayarlarƒ±")
        win.geometry("420x570")

        ctk.CTkSwitch(win, text="üìù Not Al", variable=self.not_al, text_color="black").pack(pady=5)
        ctk.CTkSwitch(win, text="Not Penceresi G√∂ster", variable=self.show_not_window, text_color="black").pack(
            pady=5
        )

        self.durum_entries = {}
        frame = ctk.CTkFrame(win)
        frame.pack(fill="both", expand=True, pady=10, padx=10)

        for i in range(1, 10):
            row = ctk.CTkFrame(frame)
            row.pack(fill="x", pady=3)
            ctk.CTkLabel(row, text=f"{i} -", width=25).pack(side="left")
            entry = ctk.CTkEntry(row, width=300)
            entry.insert(0, self.durum_tanimlari.get(i, f"Durum {i}"))
            entry.pack(side="left", padx=5)
            self.durum_entries[i] = entry

        def kaydet():
            for i in range(1, 10):
                self.durum_tanimlari[i] = self.durum_entries[i].get()
            # sadece NOT AYARLARINI kaydet (numara notlarƒ±nƒ± deƒüil)
            self.save_settings()
            win.destroy()

        ctk.CTkButton(win, text="Kaydet", command=kaydet).pack(pady=10)

    # -------------------- Not Al (numara i√ßin ge√ßici pencere) --------------------
    def _find_row_for_number(self, num: str) -> Optional[int]:
        for row, n in self.numbers:
            if n == num:
                return row
        return None

    def show_not_al_window(self, num: str):
        if self.not_win and getattr(self.not_win, "winfo_exists", lambda: False)():
            try:
                self.not_win.destroy()
            except Exception:
                pass

        self.not_win = Toplevel(self)
        self.not_win.title(f"Not Al - {num}")
        self.not_win.geometry("420x300")

        lbl = ctk.CTkLabel(
            self.not_win,
            text=f"{num}\nNumaranƒ±n durumunu se√ß veya yaz:",
            justify="left",
            text_color="black",
        )
        lbl.pack(anchor="w", padx=10, pady=10)

        self.note_entry = ctk.CTkEntry(self.not_win, width=300, placeholder_text="Durumu yaz...")
        self.note_entry.pack(pady=5)
        self.not_win.after_idle(lambda: self.note_entry.focus_force())
        self.not_win.after(200, lambda: self.note_entry.focus_force())

        scroll_frame = ctk.CTkScrollableFrame(self.not_win, width=380, height=150)
        scroll_frame.pack(fill="both", expand=True, padx=10, pady=5)

        def kaydet_durum(durum: str):
            # bu notu sadece ge√ßici olarak saklƒ±yoruz ve Excel'e yazƒ±yoruz,
            # fakat numara_durumlari JSON i√ßine kaydedilmeyecek (kullanƒ±cƒ± istediƒüi gibi)
            self.numara_durumlari[num] = durum
            if self.excel_path:
                try:
                    row_idx = self._find_row_for_number(num)
                    if row_idx is None:
                        raise ValueError("Numara excel listesinde bulunamadƒ±.")
                    wb = openpyxl.load_workbook(self.excel_path)
                    ws = wb.active
                    ws.cell(row=row_idx, column=3, value=durum)
                    wb.save(self.excel_path)
                    wb.close()
                except Exception as e:
                    messagebox.showerror("Kaydetme Hatasƒ±", f"Excel kaydedilemedi:\n{e}")
            try:
                if self.not_win:
                    self.not_win.destroy()
            except Exception:
                pass

        for i in range(1, 10):
            txt = self.durum_tanimlari.get(i, f"Durum {i}")
            btn = ctk.CTkButton(scroll_frame, text=f"{i} - {txt}", command=lambda d=txt: kaydet_durum(d))
            btn.pack(pady=2, fill="x", padx=5)

        ctk.CTkButton(self.not_win, text="Enter veya Manuel Kaydet",
                      command=lambda: kaydet_durum(self.note_entry.get())).pack(
            pady=10
        )

        self.not_win.bind("<Return>", lambda e: kaydet_durum(self.note_entry.get()))

        def handle_key(e):
            try:
                ch = getattr(e, "char", "")
                if ch.isdigit() and int(ch) in self.durum_tanimlari:
                    kaydet_durum(self.durum_tanimlari[int(ch)])
            except Exception:
                pass

        self.not_win.bind("<Key>", handle_key)

    # -------------------- Hotkey --------------------
    def on_key_press(self, key):
        try:
            # ESC tu≈üu ‚Üí botu her durumda durdur
            if key == pyn_keyboard.Key.esc:
                if self.running:
                    self.ui_call(self.toggle_bot)
                return

            # Eƒüer not penceresi a√ßƒ±ksa ve hotkey'e basƒ±lƒ±rsa kapat
            if self.not_win and getattr(self.not_win, "winfo_exists", lambda: False)():
                matches = False
                if isinstance(self.hotkey, str):
                    if hasattr(key, "char") and key.char == self.hotkey:
                        matches = True
                else:
                    if key == self.hotkey:
                        matches = True

                if matches:
                    self.ui_call(self.not_win.destroy)
                return

            # Hotkey entry'si aktifken g√∂rmezden gel
            focused = self.focus_get()
            if focused and str(focused) == str(self.entry_hotkey):
                return

            if isinstance(self.hotkey, str) and hasattr(key, "char") and key.char == self.hotkey:
                self.toggle_bot()
            elif key == self.hotkey:
                self.toggle_bot()
        except Exception:
            pass

            # -------------------- Kapanƒ±≈ü ve Excel kaydƒ± --------------------
    def on_closing(self):
        self.running = False
        self._stop_event.set()

        # stop unused worker if running
        try:
            if hasattr(self, "_unused_stop_event"):
                self._unused_stop_event.set()
                time.sleep(0.1)
        except Exception:
            pass

        if self.worker_thread and self.worker_thread.is_alive():
            self.worker_thread.join(timeout=2.0)

        try:
            if self.listener:
                self.listener.stop()
                time.sleep(0.1)
        except Exception:
            pass

        # Excel kaydƒ± (t√ºm notlarƒ± aktarma)
        if self.excel_path:
            try:
                wb = openpyxl.load_workbook(self.excel_path)
                ws = wb.active
                durum_col = 3  # C s√ºtunu
                for idx, num in self.numbers:
                    durum = self.numara_durumlari.get(num, "")
                    if durum:
                        ws.cell(row=idx, column=durum_col, value=durum)
                wb.save(self.excel_path)
                wb.close()
            except Exception as e:
                print("Excel kaydetme hatasƒ± on_closing:", e)

        try:
            self.save_settings()
        except Exception:
            pass

        try:
            self.destroy()
        except Exception:
            pass


# ================== Program Giri≈ü Noktasƒ± ==================
if __name__ == "__main__":
    app = InvektoBot()
    app.mainloop()
