import os
import sys
import platform
import uuid
import threading
import time
import json
import base64
from typing import Optional
import requests
import pyautogui
import pyperclip  # pip install pyperclip
import pythoncom  # WMI iÃ§in gerekli (Windows)
import wmi
from pynput import keyboard as pyn_keyboard
import customtkinter as ctk
from tkinter import Toplevel, filedialog, messagebox
import openpyxl
import sounddevice as sd
#import queue
#import vosk
#import random


# ---------------- MasaÃ¼stÃ¼ klasÃ¶rÃ¼ ve ayarlar dosyasÄ± ----------------
DESKTOP = os.path.join(os.path.expanduser("~"), "Desktop")
SMARTCALL_DIR = os.path.join(DESKTOP, "SmartCall")
AYARLAR_DOSYA = os.path.join(SMARTCALL_DIR, "ayarlar.json")

# KlasÃ¶r yoksa oluÅŸtur
if not os.path.exists(SMARTCALL_DIR):
    os.makedirs(SMARTCALL_DIR)


# ================== Dosya Yolu ==================
BASE_DIR = getattr(sys, "_MEIPASS", os.path.dirname(os.path.abspath(__file__)))
DESKTOP = os.path.join(os.path.expanduser("~"), "Desktop")
INVEKTO_DIR = os.path.join(DESKTOP, "Invekto")
os.makedirs(INVEKTO_DIR, exist_ok=True)
AYARLAR_DOSYA = os.path.join(INVEKTO_DIR, "ayarlar.json")

# ===== Åifreli veriler (base64) =====
_API_URL_ENC = b"aHR0cHM6Ly93b3Jrc3BhY2VzLTZvMDIub25yZW5kZXIuY29tL2FwaS92ZXJpZnk="
_SECRET_PASSPHRASE_ENC = b"c3VwZXItc2VjcmV0LXBhc3M="

_WS_PART1 = "d3NzOi8v"
_WS_PART2 = "d29ya3NwYWNlcy02bzAyLm9u"
_WS_PART3 = "cmVuZGVyLmNvbS93cy8="

SECRET_PASSPHRASE = base64.b64decode(_SECRET_PASSPHRASE_ENC).decode("utf-8")


def get_api_url() -> str:
    return base64.b64decode(_API_URL_ENC).decode()


def get_ws_url(license_key: str) -> str:
    encoded = _WS_PART1 + _WS_PART2 + _WS_PART3
    base_url = base64.b64decode(encoded).decode()
    return f"{base_url}{license_key}"


ctk.set_appearance_mode("dark")
ctk.set_default_color_theme("blue")


# ================== Ayar DosyasÄ± (dosya iÅŸlemleri) ==================
def save_settings(data):
    """Not ayarlarÄ±nÄ± Invekto klasÃ¶rÃ¼ne kaydet"""
    try:
        with open(AYARLAR_DOSYA, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    except Exception as e:
        print("save_settings hata:", e)


def load_settings_file():
    """Invekto klasÃ¶rÃ¼nden ayarlarÄ± yÃ¼kle"""
    if os.path.exists(AYARLAR_DOSYA):
        try:
            with open(AYARLAR_DOSYA, "r", encoding="utf-8") as f:
                return json.load(f)
        except Exception as e:
            print("load_settings_file hata:", e)
            return None
    return {"durum_tanimlari": {}, "not_al": False, "show_not_window": True}


# ================== Cihaz Bilgisi ==================
#def get_device_info() -> dict:
    #try:
        #mac_num = hex(uuid.getnode()).replace("0x", "").upper()
        #mac = ":".join(mac_num[i : i + 2] for i in range(0, len(mac_num), 2))
    #except Exception as e:
        #print("MAC HatasÄ±:", e)
        #mac = "00:00:00:00:00:00"

    #try:
        #cpu = platform.processor() or "UnknownCPU"
    #except Exception as e:
        #print("CPU HatasÄ±:", e)
        #cpu = "UnknownCPU"

    #bios_uuid = "UnknownUUID"
    #disk_serial = "UnknownDisk"

    #if platform.system() == "Windows":
        #try:
            #pythoncom.CoInitialize()
            #c = wmi.WMI()

            #try:
                #bios_uuid = c.Win32_ComputerSystemProduct()[0].UUID
            #except Exception as e:
                #print("BIOS UUID HatasÄ±:", e)

            #try:
                #disk_serial = c.Win32_DiskDrive()[0].SerialNumber
            #except Exception as e:
                #print("Disk Serial HatasÄ±:", e)
        #except Exception as e:
            #print("WMI eriÅŸim hatasÄ±:", e)

    #return {
        #"mac": mac,
        #"cpu": cpu,
        #"bios_uuid": bios_uuid,
        #"disk_serial": disk_serial,
    #}

# -------------------- Excel AyÄ±rma Ã–zelliÄŸi --------------------


class ExcelAyirici:
    def __init__(self, parent):
        self.parent = parent
        self.excel_path = None
        self.durumlar = []
        self.secili_durumlar = []
        self.manual_durum = ""

        self.window = ctk.CTkToplevel(parent)
        self.window.title("Excel AyÄ±rma")
        self.window.geometry("480x500")

        ctk.CTkButton(self.window, text="ğŸ“‚ Excel SeÃ§", command=self.choose_excel).pack(pady=10, fill="x", padx=20)
        self.frame_durumlar = ctk.CTkScrollableFrame(self.window, width=440, height=300)
        self.frame_durumlar.pack(padx=20, pady=10, fill="both", expand=True)

        ctk.CTkButton(self.window, text="âœ… Kaydet", command=self.save_filtered_excel, fg_color="green").pack(pady=10, fill="x", padx=20)
        ctk.CTkButton(self.window, text="âŒ Kapat", command=self.window.destroy, fg_color="red").pack(pady=5, fill="x", padx=20)

    def choose_excel(self):
        path = filedialog.askopenfilename(filetypes=[("Excel files", "*.xlsx")])
        if not path:
            return
        self.excel_path = path
        self.load_durumlar()

    def load_durumlar(self):
        for widget in self.frame_durumlar.winfo_children():
            widget.destroy()
        self.durumlar.clear()

        wb = openpyxl.load_workbook(self.excel_path)
        ws = wb.active
        for row_idx in range(2, ws.max_row + 1):
            val = ws.cell(row=row_idx, column=3).value
            if val and val not in self.durumlar:
                self.durumlar.append(val)
        wb.close()

        # Checkbox / Button listesi
        self.check_vars = {}
        for durum in self.durumlar:
            var = ctk.BooleanVar(value=False)
            chk = ctk.CTkCheckBox(self.frame_durumlar, text=durum, variable=var)
            chk.pack(anchor="w", pady=2, padx=5)
            self.check_vars[durum] = var

        # Manuel durum giriÅŸi
        ctk.CTkLabel(self.frame_durumlar, text="Manuel Durum Ekle:").pack(anchor="w", pady=(10,2), padx=5)
        self.manual_entry = ctk.CTkEntry(self.frame_durumlar)
        self.manual_entry.pack(fill="x", padx=5)

    def save_filtered_excel(self):
        # seÃ§ili durumlarÄ± al
        self.secili_durumlar = [d for d, var in self.check_vars.items() if var.get()]
        manual_val = self.manual_entry.get().strip()
        if manual_val:
            self.secili_durumlar.append(manual_val)

        if not self.secili_durumlar:
            messagebox.showwarning("UyarÄ±", "En az bir durum seÃ§in veya manuel girin!")
            return

        save_path = filedialog.asksaveasfilename(defaultextension=".xlsx", filetypes=[("Excel files", "*.xlsx")])
        if not save_path:
            return

        # Excel filtreleme ve kaydetme
        wb = openpyxl.load_workbook(self.excel_path)
        ws = wb.active
        new_wb = openpyxl.Workbook()
        new_ws = new_wb.active

        # BaÅŸlÄ±klarÄ± kopyala
        for col in range(1, ws.max_column + 1):
            new_ws.cell(row=1, column=col, value=ws.cell(row=1, column=col).value)

        new_row = 2
        for row_idx in range(2, ws.max_row + 1):
            val = ws.cell(row=row_idx, column=3).value
            if val in self.secili_durumlar:
                for col in range(1, ws.max_column + 1):
                    new_ws.cell(row=new_row, column=col, value=ws.cell(row=row_idx, column=col).value)
                new_row += 1

        new_wb.save(save_path)
        new_wb.close()
        messagebox.showinfo("TamamlandÄ±", f"{len(self.secili_durumlar)} durum seÃ§ildi ve yeni Excel kaydedildi!")

# ================== Lisans DoÄŸrulama ==================
class LicenseWindow(ctk.CTk):
    def __init__(self):
        super().__init__()
        self.title("ğŸ”‘ Lisans DoÄŸrulama")
        self.geometry("320x220")

        ctk.CTkLabel(self, text="KullanÄ±cÄ± AdÄ±:").pack(pady=6)
        self.entry_user = ctk.CTkEntry(self, width=220)
        self.entry_user.pack()

        ctk.CTkLabel(self, text="Lisans AnahtarÄ±:").pack(pady=6)
        self.entry_key = ctk.CTkEntry(self, width=220)
        self.entry_key.pack()

        ctk.CTkButton(self, text="DoÄŸrula", command=self.validate_license).pack(pady=14)

    def validate_license(self):
        username = self.entry_user.get().strip()
        key = self.entry_key.get().strip()
        if not username or not key:
            messagebox.showerror("Hata", "KullanÄ±cÄ± ve lisans giriniz.")
            return

        #device_info = get_device_info()

        #payload = {
            #"username": username,
            #"key": key,
            #"mac": device_info["mac"],
            #"cpu": device_info["cpu"],
            #"bios_uuid": device_info["bios_uuid"],
            #"disk_serial": device_info["disk_serial"],
            #"client_secret": "",
        #}

        #try:
            #r = requests.post(get_api_url(), json=payload, timeout=6)
            #r.raise_for_status()
            #data = r.json()
        #except requests.exceptions.ConnectionError:
            #messagebox.showerror(
                #"BaÄŸlantÄ± HatasÄ±",
                #"Sunucuya baÄŸlanÄ±lamadÄ±. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin."
            #)
            #return
        #except requests.exceptions.Timeout:
            #messagebox.showerror(
                #"Zaman AÅŸÄ±mÄ±",
                #"Sunucuya baÄŸlanÄ±rken zaman aÅŸÄ±mÄ±na uÄŸradÄ±. LÃ¼tfen tekrar deneyin."
            #)
            #return
        #except Exception:
            #messagebox.showerror(
                #"Hata",
                #"Lisans doÄŸrulama sÄ±rasÄ±nda bir hata oluÅŸtu. LÃ¼tfen daha sonra tekrar deneyin."
            #)
            #return

        #if data.get("status"):
            #self.destroy()
            #app = InvektoBot()
            #app.mainloop()
        #else:
            #messagebox.showerror("GeÃ§ersiz", "Lisans geÃ§ersiz veya doÄŸrulama baÅŸarÄ±sÄ±z!")



# ============================================================
# ğŸ“ KullanÄ±lmayan NumaralarÄ± AyÄ±rma Penceresi (InvektoBot ile entegre)
# ============================================================
class UnusedNumberWindow(ctk.CTkToplevel):
    def __init__(self, parent):
        super().__init__(parent)
        self.title("KullanÄ±lmayan NumaralarÄ± AyÄ±r")
        self.geometry("600x560")
        self.resizable(False, False)
        self.protocol("WM_DELETE_WINDOW", self.destroy)
        self.parent = parent

        # --- Ã‡alÄ±ÅŸma durumu ---
        self.stop_flag = False
        self.thread = None
        self.is_running = False

        # --- Ä°lerleme durumu ---
        self.total = len(getattr(self.parent, "numbers", []))
        self.current_i = getattr(self.parent, "start_index", 0)
        self.done = self.current_i
        self._start_all_ts = None
        self._avg_call_secs = 10.0

        # === ÃœST BAR ===
        topbar = ctk.CTkFrame(self)
        topbar.pack(fill="x", padx=12, pady=(12, 6))
        ctk.CTkLabel(topbar, text="ğŸ“ KullanÄ±lmayan NumaralarÄ± AyÄ±rma", font=("Arial", 16, "bold")).pack(side="left", padx=8)
        ctk.CTkButton(topbar, text="ğŸ“˜ Bilgi", width=96, height=34, command=self.open_info).pack(side="right", padx=8)

        # === DURUM SATIRLARI ===
        self.model_status = ctk.CTkLabel(self, text="", font=("Arial", 12))
        self.model_status.pack(pady=(4, 2))
        self.check_model_and_audio()

        self.label_numara = ctk.CTkLabel(self, text="Aranan Numara: -", font=("Arial", 14))
        self.label_numara.pack(pady=(6, 3))

        self.label_durum = ctk.CTkLabel(self, text="Durum: Bekleniyorâ€¦", font=("Arial", 14))
        self.label_durum.pack(pady=(2, 3))

        self.label_sayac = ctk.CTkLabel(self, text=f"{self.done} / {self.total}", font=("Arial", 12))
        self.label_sayac.pack(pady=(2, 8))

        # === Ä°LERLEME ===
        self.progress = ctk.CTkProgressBar(self, width=480)
        self.progress.pack(pady=(6, 2))
        self.progress.set((self.done / self.total) if self.total else 0)

        self.label_progress = ctk.CTkLabel(self, text=f"Ä°lerleme: %{int((self.done / self.total) * 100) if self.total else 0}", font=("Arial", 12))
        self.label_progress.pack(pady=(2, 2))

        self.label_time = ctk.CTkLabel(self, text="â³ Kalan SÃ¼re: -", font=("Arial", 12))
        self.label_time.pack(pady=(2, 12))

        # === DÄ°NLENEN METÄ°N ===
        ctk.CTkLabel(self, text="ğŸ§ Dinlenen Ses (metin):", font=("Arial", 12, "bold")).pack(pady=(2, 2))
        self.text_output = ctk.CTkTextbox(self, height=140, width=520)
        self.text_output.pack(pady=(4, 10))

        # === BUTONLAR ===
        btns = ctk.CTkFrame(self)
        btns.pack(pady=14)
        self.btn_baslat = ctk.CTkButton(btns, text="â–¶ BaÅŸlat / Devam Et", width=200, height=44,
                                        fg_color="#0B72E7", font=("Arial", 14, "bold"),
                                        command=self.start_process)
        self.btn_baslat.pack(side="left", padx=12)

        self.btn_durdur = ctk.CTkButton(btns, text="â¹ Durdur", width=200, height=44,
                                        fg_color="#D32F2F", font=("Arial", 14, "bold"),
                                        command=self.stop_process, state="disabled")
        self.btn_durdur.pack(side="left", padx=12)

        # === MODEL / AUDIO ===
        self.device_index = None
        self.model_path = self.get_model_path()
        self._warn_if_coords_missing()

    # ---------------- YardÄ±mcÄ±lar ----------------
    def _warn_if_coords_missing(self):
        if not getattr(self.parent, "ara_coord", None) or not getattr(self.parent, "kapat_coord", None):
            messagebox.showwarning(
                "Koordinatlar Eksik",
                "Arama ve/veya kapat koordinatlarÄ± atanmamÄ±ÅŸ gÃ¶rÃ¼nÃ¼yor.\n\n"
                "â€¢ 'ğŸ¯ Arama Kutusu Koordinat SeÃ§'\n"
                "â€¢ 'âŒ Ã‡aÄŸrÄ±yÄ± Bitir Koordinat SeÃ§'\n\n"
                "butonlarÄ±nÄ± kullanarak koordinatlarÄ± belirleyin."
            )

    def open_info(self):
        win = ctk.CTkToplevel(self)
        win.title("KullanÄ±m TalimatlarÄ±")
        win.geometry("520x420")
        win.resizable(False, False)
        txt = (
            "ğŸ“˜ KULLANIM TALÄ°MATI\n\n"
            "1) Model klasÃ¶rÃ¼ Ã¶ncelik sÄ±rasÄ±yla:\n"
            "   - C:\\model\n"
            "   - MasaÃ¼stÃ¼\\model\n"
            "   Bulunamazsa klasÃ¶r seÃ§im penceresi aÃ§Ä±lÄ±r.\n\n"
            "2) Ses kaynaÄŸÄ±: VB-Audio Cable Input (veya benzeri sanal cihaz).\n"
            "3) BaÅŸlat/Devam Et: kaldÄ±ÄŸÄ± satÄ±rdan devam eder.\n"
            "4) Durdur: gÃ¼venli durdurma (reset yok). Tekrar BaÅŸlat ile kaldÄ±ÄŸÄ± yerden sÃ¼rer.\n"
            "5) Ä°lerleme yÃ¼zdesi ve kalan sÃ¼re tahmini canlÄ± gÃ¼ncellenir.\n"
            "6) Koordinatlar atanmadÄ±ysa uyarÄ± verir ve aramayÄ± atlar."
        )
        tb = ctk.CTkTextbox(win, height=360, width=500)
        tb.pack(padx=10, pady=10)
        tb.insert("1.0", txt)
        tb.configure(state="disabled")

    def get_model_path(self):
        p1 = r"C:\model"
        if os.path.exists(p1):
            return p1
        desktop = os.path.join(os.environ.get("USERPROFILE", ""), "Desktop")
        p2 = os.path.join(desktop, "model")
        if os.path.exists(p2):
            return p2
        messagebox.showwarning("Model BulunamadÄ±", "Model klasÃ¶rÃ¼ bulunamadÄ±. LÃ¼tfen model klasÃ¶rÃ¼nÃ¼ seÃ§in.")
        folder = filedialog.askdirectory(title="Model KlasÃ¶rÃ¼nÃ¼ SeÃ§")
        return folder if folder else None

    def check_model_and_audio(self):
        model_ok = os.path.exists(self.get_model_path() or "")
        try:
            names = [str(d.get("name", "")) for d in sd.query_devices()]
            audio_ok = any(("VB-Audio" in n or "Cable" in n) for n in names)
        except Exception:
            audio_ok = False

        if model_ok and audio_ok:
            self.model_status.configure(text="âœ… Model ve ses kaynaÄŸÄ± hazÄ±r.", text_color="green")
        elif model_ok and not audio_ok:
            self.model_status.configure(text="âš ï¸ Model var, ses kaynaÄŸÄ± yok.", text_color="orange")
        elif not model_ok and audio_ok:
            self.model_status.configure(text="âš ï¸ Ses var, model klasÃ¶rÃ¼ yok.", text_color="orange")
        else:
            self.model_status.configure(text="âš ï¸ Model ve ses kaynaÄŸÄ± eksik.", text_color="orange")

    # ---------------- BaÅŸlat / Durdur ----------------
    def start_process(self):
        if self.is_running:
            return
        if not getattr(self.parent, "numbers", None):
            messagebox.showwarning("UyarÄ±", "Ã–nce Excelâ€™den numaralarÄ± yÃ¼kleyin.")
            return

        self.stop_flag = False
        self.is_running = True
        self.btn_baslat.configure(state="disabled")
        self.btn_durdur.configure(state="normal")
        self.label_durum.configure(text="Durum: BaÅŸlatÄ±ldÄ±â€¦")

        if self._start_all_ts is None:
            self._start_all_ts = time.time()

        if self.done == 0:
            self.text_output.delete("1.0", "end")

        self.thread = threading.Thread(target=self.run_cycle, daemon=True)
        self.thread.start()

    def stop_process(self):
        self.stop_flag = True
        self.is_running = False
        self.btn_durdur.configure(state="disabled")
        self.btn_baslat.configure(state="normal")
        self.label_durum.configure(text="Durum: Durduruldu (kaldÄ±ÄŸÄ± yer kayÄ±tlÄ±).")

    # ---------------- Ana DÃ¶ngÃ¼ ----------------
    def run_cycle(self):
        try:
            while not self.stop_flag and self.current_i < self.total:
                row_idx, num = self.parent.numbers[self.current_i]
                num_str = str(num)

                self.label_numara.configure(text=f"Aranan Numara: {num_str}")
                self.label_durum.configure(text="Durum: Arama baÅŸlatÄ±lÄ±yorâ€¦")
                self.update_idletasks()

                call_start = time.time()
                try:
                    if getattr(self.parent, "ara_coord", None):
                        x, y = self.parent.ara_coord
                        pyautogui.click(x, y)
                        time.sleep(0.15)
                        pyautogui.click(x, y)
                        pyperclip.copy(num_str)
                        pyautogui.hotkey("ctrl", "v")
                        time.sleep(0.08)
                        pyautogui.press("enter")
                except Exception as e:
                    print("TÄ±klama/Arama hatasÄ±:", e)

                # === Ses dinleme ===
                transcript = self.listen_for_keywords(duration=10)
                durum = self.analyze_result(transcript)
                self.text_output.insert("end", f"\n[{num_str}] â†’ {durum}\n")
                self.text_output.see("end")

                try:
                    if getattr(self.parent, "kapat_coord", None):
                        pyautogui.click(*self.parent.kapat_coord)
                except Exception as e:
                    print("Kapat tÄ±klama hatasÄ±:", e)

                # === Excel'e yaz ===
                try:
                    excel_path = getattr(self.parent, "excel_path", None)
                    if excel_path and os.path.exists(excel_path):
                        wb = openpyxl.load_workbook(excel_path)
                        ws = wb.active

                        for row in range(1, ws.max_row + 1):
                            cell_val = str(ws.cell(row=row, column=1).value).strip() if ws.cell(row=row, column=1).value else ""
                            if cell_val == num_str:
                                ws.cell(row=row, column=3).value = durum
                                break

                        wb.save(excel_path)
                        wb.close()
                except Exception as e:
                    print("Excel'e yazma hatasÄ±:", e)

                # sayaÃ§ ve ilerleme
                self.done += 1
                self.current_i += 1
                self.label_sayac.configure(text=f"{self.done} / {self.total}")
                self.progress.set(self.done / self.total if self.total else 0)
                self.label_progress.configure(text=f"Ä°lerleme: %{int((self.done / self.total) * 100) if self.total else 0}")
                call_dur = time.time() - call_start
                self._avg_call_secs = (self._avg_call_secs * 0.7) + (call_dur * 0.3)
                remaining = max(self.total - self.done, 0) * self._avg_call_secs
                self.label_time.configure(text=f"â³ Kalan SÃ¼re: {int(remaining)} sn")
                self.update_idletasks()

            if not self.stop_flag:
                self.label_durum.configure(text="Durum: TamamlandÄ± âœ…")
                messagebox.showinfo("Bilgi", "KullanÄ±lmayan numaralar tamamlandÄ±.")
        finally:
            self.is_running = False
            self.btn_durdur.configure(state="disabled")
            self.btn_baslat.configure(state="normal")




# ================== Ana Bot ==================
class InvektoBot(ctk.CTk):
    def __init__(self):
        super().__init__()
        self.title("ğŸ“ Invekto Smart Call")
        self.geometry("360x600")

        # Excel / arama deÄŸiÅŸkenleri
        self.excel_path: Optional[str] = None
        self.ara_coord = None
        self.kapat_coord = None
        self.numbers: list[tuple[int, str]] = []
        self.start_index = 0
        self.running = False
        self.worker_thread: Optional[threading.Thread] = None

        # Not ayarlarÄ± ve UI deÄŸiÅŸkenleri
        self.not_al = ctk.BooleanVar(value=False)
        self.otomatik_mod = ctk.BooleanVar(value=False)
        self.show_not_window = ctk.BooleanVar(value=True)

        # Hotkey: default F8
        self.hotkey = pyn_keyboard.Key.f8
        self.hotkey_str = "f8"

        # durum tanÄ±mlarÄ± (1..9)
        self.durum_tanimlari = {i: f"Durum {i}" for i in range(1, 10)}

        # numaralara ait geÃ§ici notlar
        self.numara_durumlari: dict[str, str] = {}

        # UI / pencere referanslarÄ±
        self.durum_entries = {}
        self.not_win = None
        self.current_num = None
        self.unused_win = None  # yeni pencere referansÄ±

        self._stop_event = threading.Event()

        self.stop_unused = False

        # runtime timer baÅŸlat
        self._start_runtime_timer(max_seconds=68400)

        # UI oluÅŸtur
        self._build_ui()

        # AyarlarÄ± yÃ¼kle
        try:
            self.load_settings()
        except Exception as e:
            print("load_settings hata:", e)

        # klavye dinleyici
        self.listener = pyn_keyboard.Listener(on_press=self.on_key_press)
        self.listener.start()

        self.protocol("WM_DELETE_WINDOW", self.on_closing)

    # -------------------- KullanÄ±lmayan NumaralarÄ± AyÄ±rma --------------------
    def open_unused_window(self):
        """KullanÄ±lmayan numaralarÄ± ayÄ±rma ekranÄ±nÄ± aÃ§."""
        try:
            # EÄŸer pencere zaten aÃ§Ä±ksa yeniden oluÅŸturma
            if hasattr(self, "unused_window") and self.unused_window and self.unused_window.winfo_exists():
                self.unused_window.focus()
                return

            # Yeni pencere aÃ§
            self.unused_window = UnusedNumberWindow(self)
            self.unused_window.grab_set()
            print("[INFO] KullanÄ±lmayan numaralar penceresi aÃ§Ä±ldÄ±.")

        except Exception as e:
            print("[HATA] KullanÄ±lmayan numaralar penceresi aÃ§Ä±lamadÄ±:", e)
            messagebox.showerror("Hata", f"Pencere aÃ§Ä±lÄ±rken hata oluÅŸtu:\n{e}")

    # -------------------- UI --------------------
    def _build_ui(self):
        self.label_sayac = ctk.CTkLabel(self, text="Aranan: 0/0  |  Kalan: 0", font=("Arial", 14))
        self.label_sayac.pack(pady=10)

        frame_top = ctk.CTkFrame(self)
        frame_top.pack(pady=5, fill="x", padx=10)
        ctk.CTkButton(frame_top, text="ğŸ“‚ Excel SeÃ§", command=self.load_excel).pack(pady=5, fill="x")
        ctk.CTkButton(frame_top, text="ğŸ¯ Arama Kutusu Kordinat SeÃ§", command=self.set_coord).pack(pady=5, fill="x")
        ctk.CTkButton(frame_top, text="âŒ Ã‡aÄŸrÄ±yÄ± Bitir Kordinat SeÃ§", command=self.set_kapat_coord,
                      fg_color="#B71C1C", text_color="white", hover_color="#7F0000").pack(pady=5, fill="x")

        self.btn_start = ctk.CTkButton(frame_top, text="â–¶ BaÅŸlat", command=self.toggle_bot, fg_color="green")
        self.btn_start.pack(pady=5, fill="x")

        frame_mod = ctk.CTkFrame(self)
        frame_mod.pack(pady=5, fill="x", padx=10)
        ctk.CTkSwitch(frame_mod, text="", variable=self.otomatik_mod,
                      text_color="white").pack(side="left", padx=5)
        ctk.CTkLabel(frame_mod, text="(ESC ile durdur)", text_color="red").pack(side="left", padx=10)

        frame_hotkey = ctk.CTkFrame(self)
        frame_hotkey.pack(pady=5, fill="x", padx=10)
        ctk.CTkLabel(frame_hotkey, text="BaÅŸlat/Durdur TuÅŸu:").pack(side="left", padx=5)
        self.entry_hotkey = ctk.CTkEntry(frame_hotkey, placeholder_text="Ã¶rn: F8 veya z", width=120)
        self.entry_hotkey.pack(side="left", padx=5)
        ctk.CTkButton(frame_hotkey, text="Ata", command=self.set_hotkey).pack(side="left", padx=5)

        frame_durum_btn = ctk.CTkFrame(self)
        frame_durum_btn.pack(pady=5, fill="x", padx=10)
        ctk.CTkButton(frame_durum_btn, text="ğŸ“ Not AyarlarÄ±", command=self.open_not_ayar).pack(pady=5, fill="x")

        frame_bottom = ctk.CTkFrame(self)
        frame_bottom.pack(pady=5, fill="x", padx=10)
        ctk.CTkButton(frame_bottom, text="ğŸ’¾ Excelâ€™i Kaydet", command=self.save_excel, fg_color="blue").pack(
            side="left", expand=True, fill="x", padx=5, pady=5)
        ctk.CTkButton(frame_bottom, text="ğŸ’¾ Kaydet & Ã‡Ä±k", command=self.on_closing, fg_color="red").pack(
            side="left", expand=True, fill="x", padx=5, pady=5)

        frame_extra = ctk.CTkFrame(self)
        frame_extra.pack(side="bottom", fill="x", padx=10, pady=10)
        ctk.CTkButton(frame_extra, text="ğŸ“Š Excel AyÄ±r", command=lambda: ExcelAyirici(self),
                      fg_color="#1976D2", text_color="white", hover_color="#1565C0").pack(pady=5, fill="x")
        #ctk.CTkButton(frame_extra, text="Invekto Call Bot +", command=self.open_extra_window,
                      #fg_color="#4CAF50", text_color="white", hover_color="#2E7D32").pack(pady=2, fill="x")
        ctk.CTkButton(frame_extra, text="KullanÄ±lmayanlarÄ± AyÄ±r", command=self.open_unused_window,
                      fg_color="#9C27B0", text_color="white", hover_color="#7B1FA2").pack(pady=5, fill="x")

        ctk.CTkLabel(frame_extra, text="model:0.0.1", font=("Arial", 10), text_color="gray").pack(pady=2)

        # ---- Excel Kaydet Fonksiyonu ----

    def save_excel(self):
        if not self.excel_path:
            messagebox.showwarning("UyarÄ±", "Kaydedilecek bir Excel dosyasÄ± yok!")
            return
        try:
            wb = openpyxl.load_workbook(self.excel_path)
            ws = wb.active
            durum_col = 3
            for idx, num in self.numbers:
                durum = self.numara_durumlari.get(num, "")
                if durum:  # sadece durum varsa gÃ¼ncelle
                    ws.cell(row=idx, column=durum_col, value=durum)
            wb.save(self.excel_path)
            wb.close()

            messagebox.showinfo(
                "Kaydedildi",
                f"Notlar '{os.path.basename(self.excel_path)}' dosyasÄ±na kaydedildi."
            )
        except Exception as e:
            messagebox.showerror("Kaydetme HatasÄ±", f"Excel kaydedilemedi:\n{e}")

    # -------------------- GÃ¼venli KapanÄ±ÅŸ --------------------
    def safe_exit(self):
        try:
            self.on_closing()
        except Exception as e:
            print("KapanÄ±ÅŸ sÄ±rasÄ±nda hata:", e)
        finally:
            try:
                os._exit(0)
            except Exception:
                pass

    # -------------------- Runtime Timer --------------------
    def _runtime_timer(self, max_seconds):
        start_time = time.time()
        while not self._stop_event.is_set():
            if time.time() - start_time >= max_seconds:
                print(f"{max_seconds} saniye geÃ§ti, program kapanÄ±yor...")
                try:
                    self.after(0, self.safe_exit)
                except Exception:
                    self.safe_exit()
                break
            time.sleep(0.5)

    def _start_runtime_timer(self, max_seconds):
        t = threading.Thread(target=self._runtime_timer, args=(max_seconds,), daemon=True)
        t.start()

    # -------------------- Ayar Kaydet / YÃ¼kle (SADECE NOT AYARLARI) -------------------
    def save_settings(self):
        """
        Sadece 'Not AyarlarÄ±' kalÄ±cÄ± olacak:
        - durum_tanimlari (anahtarlar string olarak yazÄ±lÄ±r)
        - not_al (bool)
        - show_not_window (bool)
        - hotkey_str (string)
        NOT: numara_durumlari veya excel verileri JSON'a yazÄ±lmaz.
        """
        try:
            data = {
                "durum_tanimlari": {str(k): v for k, v in self.durum_tanimlari.items()},
                "not_al": bool(self.not_al.get()),
                "show_not_window": bool(self.show_not_window.get()),
                "hotkey_str": getattr(self, "hotkey_str", "") or "",
            }
            # global fonksiyonu Ã§aÄŸÄ±r
            save_settings(data)
        except Exception as e:
            print("Ayarlar kaydedilemedi:", e)

    def load_settings(self):
        """
        YÃ¼kleme: JSON'dan durum_tanimlari alÄ±nÄ±r (string anahtarlar -> int anahtarlar).
        AyrÄ±ca not_al, show_not_window ve hotkey_str geri yÃ¼klenir.
        """
        data = load_settings_file()
        if not data:
            return

        # durum_tanimlari: anahtarlarÄ± int'e Ã§evir
        raw = data.get("durum_tanimlari", {})
        converted = {}
        for k, v in raw.items():
            try:
                ik = int(k)
            except Exception:
                continue
            converted[ik] = v
        if converted:
            self.durum_tanimlari.update(converted)

        # boolean ayarlar
        try:
            self.not_al.set(bool(data.get("not_al", False)))
            self.show_not_window.set(bool(data.get("show_not_window", True)))
        except Exception:
            pass

        # hotkey_str
        hk = data.get("hotkey_str", "")
        if hk:
            try:
                if isinstance(hk, str) and hk.startswith("f") and hk[1:].isdigit():
                    self.hotkey = getattr(pyn_keyboard.Key, hk)
                else:
                    self.hotkey = hk
                self.hotkey_str = hk
                # entry varsa doldur
                try:
                    if hasattr(self, "entry_hotkey") and isinstance(self.entry_hotkey, ctk.CTkEntry):
                        self.entry_hotkey.delete(0, "end")
                        self.entry_hotkey.insert(0, hk)
                except Exception:
                    pass
            except Exception:
                self.hotkey_str = hk

    # -------------------- UI / Excel --------------------
    def ui_call(self, fn, *args, **kwargs):
        self.after(0, lambda: fn(*args, **kwargs))

    def load_excel(self):
        path = filedialog.askopenfilename(filetypes=[("Excel files", "*.xlsx")])
        if not path:
            return
        try:
            wb = openpyxl.load_workbook(path)
            sheet = wb.active
            self.numbers.clear()
            for row_idx in range(2, sheet.max_row + 1):
                num = sheet.cell(row=row_idx, column=1).value
                if num:
                    self.numbers.append((row_idx, str(num)))
            wb.close()
            self.excel_path = path

            def set_start():
                try:
                    start_val = int(entry_start.get())
                    if start_val < 1 or start_val > len(self.numbers):
                        raise ValueError
                    self.start_index = start_val - 1
                    top.destroy()
                    messagebox.showinfo(
                        "Excel YÃ¼klendi", f"{len(self.numbers)} numara bulundu.\nBaÅŸlangÄ±Ã§ satÄ±rÄ±: {start_val}"
                    )
                    self.update_sayac()
                except Exception:
                    messagebox.showerror("Hata", "GeÃ§erli bir sayÄ± giriniz!")

            top = Toplevel(self)
            top.title("BaÅŸlangÄ±Ã§ SatÄ±rÄ±")
            top.geometry("400x180")

            lbl = ctk.CTkLabel(top, text="KaÃ§Ä±ncÄ± sÄ±radan baÅŸlansÄ±n?", text_color="black")
            lbl.pack(pady=15)

            entry_start = ctk.CTkEntry(top, width=120)
            entry_start.insert(0, "1")
            entry_start.pack(pady=10)

            btn_ok = ctk.CTkButton(top, text="Tamam", command=set_start)
            btn_ok.pack(pady=10)

        except Exception as e:
            messagebox.showerror("Hata", f"Excel okunamadÄ±:\n{e}")

    def set_coord(self):
        messagebox.showinfo("Koordinat", "Arama kutusuna fareyi gÃ¶tÃ¼r ve 3 sn bekle...")
        self.after(3000, self._capture_ara_coord)

    def _capture_ara_coord(self):
        self.ara_coord = pyautogui.position()
        messagebox.showinfo("Koordinat", f"Arama Kutusu: {self.ara_coord}")

    def set_kapat_coord(self):
        messagebox.showinfo("Koordinat", "Kapat butonuna fareyi gÃ¶tÃ¼r ve 3 sn bekle...")
        self.after(3000, self._capture_kapat_coord)

    def _capture_kapat_coord(self):
        self.kapat_coord = pyautogui.position()
        messagebox.showinfo("Koordinat", f"Arama Kapat: {self.kapat_coord}")

    def set_hotkey(self):
        key = self.entry_hotkey.get().strip().lower()
        if not key:
            messagebox.showerror("Hata", "LÃ¼tfen bir tuÅŸ girin! (Ã¶rn: F8 veya z)")
            return
        try:
            if key.startswith("f") and key[1:].isdigit():
                # e.g. f8 -> Key.f8
                self.hotkey = getattr(pyn_keyboard.Key, key)
            else:
                # single character hotkey
                self.hotkey = key
            self.hotkey_str = key
            messagebox.showinfo("KÄ±sayol AyarlandÄ±", f"BaÅŸlat/Durdur iÃ§in yeni tuÅŸ: {key.upper()}")
            # deÄŸiÅŸikliÄŸi kaydet (sadece not ayarlarÄ±nÄ± kaydeder, numara notlarÄ±nÄ± deÄŸil)
            try:
                self.save_settings()
            except Exception:
                pass
        except Exception as e:
            messagebox.showerror("Hata", f"KÄ±sayol atanamadÄ±: {e}")

    def update_sayac(self):
        self.label_sayac.configure(
            text=f"Aranan: {self.start_index}/{len(self.numbers)}  |  Kalan: {max(0, len(self.numbers) - self.start_index)}"
        )

    # -------------------- Bot Ã‡alÄ±ÅŸtÄ±r / Durdur --------------------
    def toggle_bot(self):
        if self.running:
            self.running = False
            self._stop_event.set()
            if self.worker_thread and self.worker_thread.is_alive():
                self.worker_thread.join(timeout=1.0)
            self.btn_start.configure(text="â–¶ BaÅŸlat", fg_color="green")
        else:
            if not self.numbers:
                messagebox.showwarning("UyarÄ±", "Ã–nce Excel yÃ¼kleyin.")
                return
            self.running = True
            self._stop_event.clear()
            self.worker_thread = threading.Thread(target=self.run_bot, daemon=True)
            self.worker_thread.start()
            self.btn_start.configure(text="â¹ Durdur", fg_color="red")

    def run_bot(self):
        while self.running and not self._stop_event.is_set() and self.start_index < len(self.numbers):
            idx, num = self.numbers[self.start_index]

            try:
                if self.ara_coord:
                    pyautogui.click(self.ara_coord)
                    time.sleep(0.1)
                    pyautogui.click(self.ara_coord)
                    pyperclip.copy(str(num))  # str() ekledik
                    pyautogui.hotkey("ctrl", "v")
                    time.sleep(0.05)
                    pyautogui.press("enter")

                if self.otomatik_mod.get() and self.kapat_coord:
                    time.sleep(__import__("random").randint(4, 7))
                    pyautogui.click(self.kapat_coord)
                    time.sleep(0.7)

                self.start_index += 1
                self.ui_call(self.update_sayac)

                if self.not_al.get() and self.show_not_window.get():
                    self.current_num = num
                    self.ui_call(self.show_not_al_window, num)

                if not self.otomatik_mod.get():
                    break

            except Exception as e:
                print("run_bot hata:", e)
                self.start_index += 1

        self.running = False
        self.ui_call(self.btn_start.configure, text="â–¶ BaÅŸlat", fg_color="green")

    # -------------------- Not AyarlarÄ± --------------------
    def open_not_ayar(self):
        win = Toplevel(self)
        win.title("Not AyarlarÄ±")
        win.geometry("420x570")

        ctk.CTkSwitch(win, text="ğŸ“ Not Al", variable=self.not_al, text_color="black").pack(pady=5)
        ctk.CTkSwitch(win, text="Not Penceresi GÃ¶ster", variable=self.show_not_window, text_color="black").pack(
            pady=5
        )

        self.durum_entries = {}
        frame = ctk.CTkFrame(win)
        frame.pack(fill="both", expand=True, pady=10, padx=10)

        for i in range(1, 10):
            row = ctk.CTkFrame(frame)
            row.pack(fill="x", pady=3)
            ctk.CTkLabel(row, text=f"{i} -", width=25).pack(side="left")
            entry = ctk.CTkEntry(row, width=300)
            entry.insert(0, self.durum_tanimlari.get(i, f"Durum {i}"))
            entry.pack(side="left", padx=5)
            self.durum_entries[i] = entry

        def kaydet():
            for i in range(1, 10):
                self.durum_tanimlari[i] = self.durum_entries[i].get()
            # sadece NOT AYARLARINI kaydet (numara notlarÄ±nÄ± deÄŸil)
            self.save_settings()
            win.destroy()

        ctk.CTkButton(win, text="Kaydet", command=kaydet).pack(pady=10)

    # -------------------- Not Al (numara iÃ§in geÃ§ici pencere) --------------------
    def _find_row_for_number(self, num: str) -> Optional[int]:
        for row, n in self.numbers:
            if n == num:
                return row
        return None

    def show_not_al_window(self, num: str):
        if self.not_win and getattr(self.not_win, "winfo_exists", lambda: False)():
            try:
                self.not_win.destroy()
            except Exception:
                pass

        self.not_win = Toplevel(self)
        self.not_win.title(f"Not Al - {num}")
        self.not_win.geometry("420x300")

        lbl = ctk.CTkLabel(
            self.not_win,
            text=f"{num}\nNumaranÄ±n durumunu seÃ§ veya yaz:",
            justify="left",
            text_color="black",
        )
        lbl.pack(anchor="w", padx=10, pady=10)

        self.note_entry = ctk.CTkEntry(self.not_win, width=300, placeholder_text="Durumu yaz...")
        self.note_entry.pack(pady=5)
        self.not_win.after_idle(lambda: self.note_entry.focus_force())
        self.not_win.after(200, lambda: self.note_entry.focus_force())

        scroll_frame = ctk.CTkScrollableFrame(self.not_win, width=380, height=150)
        scroll_frame.pack(fill="both", expand=True, padx=10, pady=5)

        def kaydet_durum(durum: str):
            # bu notu sadece geÃ§ici olarak saklÄ±yoruz ve Excel'e yazÄ±yoruz,
            # fakat numara_durumlari JSON iÃ§ine kaydedilmeyecek (kullanÄ±cÄ± istediÄŸi gibi)
            self.numara_durumlari[num] = durum
            if self.excel_path:
                try:
                    row_idx = self._find_row_for_number(num)
                    if row_idx is None:
                        raise ValueError("Numara excel listesinde bulunamadÄ±.")
                    wb = openpyxl.load_workbook(self.excel_path)
                    ws = wb.active
                    ws.cell(row=row_idx, column=3, value=durum)
                    wb.save(self.excel_path)
                    wb.close()
                except Exception as e:
                    messagebox.showerror("Kaydetme HatasÄ±", f"Excel kaydedilemedi:\n{e}")
            try:
                if self.not_win:
                    self.not_win.destroy()
            except Exception:
                pass

        for i in range(1, 10):
            txt = self.durum_tanimlari.get(i, f"Durum {i}")
            btn = ctk.CTkButton(scroll_frame, text=f"{i} - {txt}", command=lambda d=txt: kaydet_durum(d))
            btn.pack(pady=2, fill="x", padx=5)

        ctk.CTkButton(self.not_win, text="Enter veya Manuel Kaydet",
                      command=lambda: kaydet_durum(self.note_entry.get())).pack(
            pady=10
        )

        self.not_win.bind("<Return>", lambda e: kaydet_durum(self.note_entry.get()))

        def handle_key(e):
            try:
                ch = getattr(e, "char", "")
                if ch.isdigit() and int(ch) in self.durum_tanimlari:
                    kaydet_durum(self.durum_tanimlari[int(ch)])
            except Exception:
                pass

        self.not_win.bind("<Key>", handle_key)

    # -------------------- Hotkey --------------------
    def on_key_press(self, key):
        try:
            # ESC tuÅŸu â†’ botu her durumda durdur
            if key == pyn_keyboard.Key.esc:
                if self.running:
                    self.ui_call(self.toggle_bot)
                return

            # EÄŸer not penceresi aÃ§Ä±ksa ve hotkey'e basÄ±lÄ±rsa kapat
            if self.not_win and getattr(self.not_win, "winfo_exists", lambda: False)():
                matches = False
                if isinstance(self.hotkey, str):
                    if hasattr(key, "char") and key.char == self.hotkey:
                        matches = True
                else:
                    if key == self.hotkey:
                        matches = True

                if matches:
                    self.ui_call(self.not_win.destroy)
                return

            # Hotkey entry'si aktifken gÃ¶rmezden gel
            focused = self.focus_get()
            if focused and str(focused) == str(self.entry_hotkey):
                return

            if isinstance(self.hotkey, str) and hasattr(key, "char") and key.char == self.hotkey:
                self.toggle_bot()
            elif key == self.hotkey:
                self.toggle_bot()
        except Exception:
            pass

            # -------------------- KapanÄ±ÅŸ ve Excel kaydÄ± --------------------
    def on_closing(self):
        self.running = False
        self._stop_event.set()

        # stop unused worker if running
        try:
            if hasattr(self, "_unused_stop_event"):
                self._unused_stop_event.set()
                time.sleep(0.1)
        except Exception:
            pass

        if self.worker_thread and self.worker_thread.is_alive():
            self.worker_thread.join(timeout=2.0)

        try:
            if self.listener:
                self.listener.stop()
                time.sleep(0.1)
        except Exception:
            pass

        # Excel kaydÄ± (tÃ¼m notlarÄ± aktarma)
        if self.excel_path:
            try:
                wb = openpyxl.load_workbook(self.excel_path)
                ws = wb.active
                durum_col = 3  # C sÃ¼tunu
                for idx, num in self.numbers:
                    durum = self.numara_durumlari.get(num, "")
                    if durum:
                        ws.cell(row=idx, column=durum_col, value=durum)
                wb.save(self.excel_path)
                wb.close()
            except Exception as e:
                print("Excel kaydetme hatasÄ± on_closing:", e)

        try:
            self.save_settings()
        except Exception:
            pass

        try:
            self.destroy()
        except Exception:
            pass


# ================== Program GiriÅŸ NoktasÄ± ==================
if __name__ == "__main__":
    #info = get_device_info()
    #print(info)

    # --- Lisans ekranÄ±nÄ± ÅŸimdilik devre dÄ±ÅŸÄ± bÄ±rakÄ±yoruz ---
    # win = LicenseWindow()
    # win.mainloop()

    # --- Program doÄŸrudan baÅŸlasÄ±n ---
    app = InvektoBot()
    app.mainloop()



